{% extends 'sidebar.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users text-primary me-2"></i>Gestão de Pacientes</h2>
    <button class="btn btn-success" onclick="abrirModalNovo()">
        <i class="fas fa-plus me-2"></i>Novo Paciente
    </button>
</div>

<div class="card shadow-sm mb-4 border-0">
    <div class="card-body bg-light rounded">
        <form method="GET" class="row g-2 align-items-center" id="searchForm">
            <div class="col-md-10">
                <div class="input-group">
                    <span class="input-group-text bg-white text-muted"><i class="fas fa-search"></i></span>
                    <input type="text" name="busca" id="inputBusca" class="form-control border-start-0 ps-0"
                           placeholder="Digite Nome, CPF ou CROSS para filtrar instantaneamente..."
                           value="{{ request.GET.busca|default:'' }}" autocomplete="off" autofocus>
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
            {% if request.GET.busca %}
            <div class="col-12 mt-2">
                <a href="{% url 'gestao_pacientes' %}" class="small text-danger text-decoration-none">
                    <i class="fas fa-times me-1"></i>Limpar Filtros do Servidor
                </a>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Sexo</th>
                        <th>Idade</th>
                        <th>Município</th>
                        <th>Telefone</th>
                        <th>Status</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaPacientes">
                    {% for p in pacientes %}
                    <tr class="paciente-row"
                        data-filter="{{ p.nome|lower }} {{ p.cpf }} {{ p.siresp|default:'' }}">

                        <td class="fw-bold">
                            <a href="{% url 'detalhe_paciente' p.id %}" class="text-decoration-none text-dark hover-link">
                                {{ p.nome }} <i class="fas fa-external-link-alt ms-1 text-muted small" style="font-size: 0.7em;"></i>
                            </a>
                            {% if p.siresp %}
                                <div style="font-size: 0.7rem;" class="text-muted">CROSS: {{ p.siresp }}</div>
                            {% endif %}
                        </td>
                        <td>{{ p.cpf }}</td>
                        <td>
                            {% if p.sexo == 'M' %}
                                <i class="fas fa-mars text-primary" title="Masculino"></i>
                            {% elif p.sexo == 'F' %}
                                <i class="fas fa-venus text-danger" title="Feminino"></i>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ p.idade }} anos</td>
                        <td>{{ p.municipio }}</td>
                        <td>{{ p.telefone }}</td>
                        <td>
                            {% if p.ativo %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <a href="{% url 'atendimento_hub' %}?busca_termo={{ p.cpf }}" class="btn btn-sm btn-outline-danger me-1" title="Novo Atendimento">
                                <i class="fas fa-heartbeat"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-primary" onclick="editarPaciente({{ p.id }})" title="Editar Cadastro">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="no-results">
                        <td colspan="8" class="text-center text-muted py-4">Nenhum paciente encontrado.</td>
                    </tr>
                    {% endfor %}
                    <tr id="nenhum-encontrado" style="display: none;">
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-filter me-2"></i>Nenhum paciente corresponde à sua busca.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPaciente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitulo">Novo Paciente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form action="{% url 'salvar_paciente' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="paciente_id" id="paciente_id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" name="nome" id="nome" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Nasc.</label>
                            <input type="date" class="form-control" name="data_nascimento" id="data_nascimento" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-primary fw-bold">Admissão</label>
                            <input type="date" class="form-control border-primary" name="data_insercao" id="data_insercao" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" name="cpf" id="cpf" maxlength="14">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Sexo</label>
                            <select class="form-select" name="sexo" id="sexo" required>
                                <option value="" selected disabled>Selecione...</option>
                                <option value="M">Masculino</option>
                                <option value="F">Feminino</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Etnia/Cor</label>
                            <select class="form-select" name="etnia" id="etnia" required>
                                <option value="" selected disabled>Selecione...</option>
                                <option value="Branca">Branca</option>
                                <option value="Parda">Parda</option>
                                <option value="Negra">Negra</option>
                                <option value="Indígena">Indígena</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Município</label>
                            <select class="form-select" name="municipio" id="municipio">
                                <option value="Caraguatatuba">Caraguatatuba</option>
                                <option value="Ubatuba">Ubatuba</option>
                                <option value="São Sebastião">São Sebastião</option>
                                <option value="Ilhabela">Ilhabela</option>
                                <option value="Paraibuna">Paraibuna</option>
                                <option value="Natividade da Serra">Natividade da Serra</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone</label>
                            <input type="text" class="form-control" name="telefone" id="telefone">
                        </div>
                    </div>

                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" name="ativo" id="ativo" checked>
                        <label class="form-check-label" for="ativo">Paciente Ativo na Linha de Cuidado</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Paciente</button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
    // --- LÓGICA DE FILTRO DINÂMICO ---
    document.addEventListener('DOMContentLoaded', function() {
        const inputBusca = document.getElementById('inputBusca');
        const linhas = document.querySelectorAll('.paciente-row');
        const msgNenhum = document.getElementById('nenhum-encontrado');
        const msgOriginal = document.getElementById('no-results'); // Msg do backend

        inputBusca.addEventListener('keyup', function() {
            const termo = this.value.toLowerCase();
            let visiveis = 0;

            linhas.forEach(row => {
                // Pega os dados concatenados (Nome + CPF + CROSS)
                const texto = row.getAttribute('data-filter');

                if (texto.includes(termo)) {
                    row.style.display = '';
                    visiveis++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Controle da mensagem de "Nenhum encontrado"
            if (visiveis === 0) {
                if(msgOriginal) msgOriginal.style.display = 'none'; // Esconde msg original se houver
                msgNenhum.style.display = '';
            } else {
                msgNenhum.style.display = 'none';
            }
        });
    });

    // --- FUNÇÕES MODAL ---
    function abrirModalNovo() {
        document.getElementById('modalTitulo').innerText = "Novo Paciente";
        document.getElementById('paciente_id').value = "";
        document.getElementById('nome').value = "";
        document.getElementById('cpf').value = "";
        document.getElementById('sexo').value = "";
        document.getElementById('etnia').value = "";
        document.getElementById('data_nascimento').value = "";
        document.getElementById('telefone').value = "";
        document.getElementById('ativo').checked = true;

        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data_insercao').value = hoje;

        new bootstrap.Modal(document.getElementById('modalPaciente')).show();
    }

    function editarPaciente(id) {
        fetch(`/api/paciente/${id}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalTitulo').innerText = "Editar Paciente";
                document.getElementById('paciente_id').value = data.id;
                document.getElementById('nome').value = data.nome;
                document.getElementById('cpf').value = data.cpf;
                document.getElementById('sexo').value = data.sexo;
                document.getElementById('etnia').value = data.etnia;
                document.getElementById('data_nascimento').value = data.data_nascimento;
                document.getElementById('municipio').value = data.municipio;
                document.getElementById('telefone').value = data.telefone;
                document.getElementById('data_insercao').value = data.data_insercao;
                document.getElementById('ativo').checked = data.ativo;

                new bootstrap.Modal(document.getElementById('modalPaciente')).show();
            })
            .catch(error => console.error('Erro:', error));
    }
</script>

<style>
    .hover-link:hover {
        color: #004587 !important; /* Azul Seconci */
        text-decoration: underline !important;
    }
</style>
{% endblock %}