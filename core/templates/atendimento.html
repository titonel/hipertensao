{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-user-nurse text-danger me-2"></i>Atendimento Clínico</h2>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="POST" action="{% url 'atendimento' %}" class="row g-3">
                {% csrf_token %}
                <div class="col-md-10">
                    <input type="text" name="busca_termo" class="form-control form-control-lg" placeholder="Digite o Nome ou CPF do paciente..." autofocus>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-search me-2"></i>Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if paciente %}
    <div class="row">
        <div class="col-md-7">
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Novo Registro Clínico</h5>
                    <span>{{ paciente.nome }}</span>
                </div>
                <div class="card-body bg-light">

                    <form action="{% url 'registrar_afericao' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="paciente_id" value="{{ paciente.id }}">

                        <h6 class="text-primary border-bottom pb-2 mb-3">Sinais Vitais & Antropometria</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <label class="small fw-bold">PAS (mmHg)</label>
                                <input type="number" name="sistolica" class="form-control border-primary" required placeholder="120">
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold">PAD (mmHg)</label>
                                <input type="number" name="diastolica" class="form-control border-primary" required placeholder="80">
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted">FC (bpm)</label>
                                <input type="number" name="fc" class="form-control" placeholder="-">
                            </div>
                        </div>

                        <div class="row g-2 mb-4">
                            <div class="col-md-3">
                                <label class="small text-muted">Peso (Kg)</label>
                                <input type="number" step="0.01" name="peso" id="inputPeso" class="form-control" placeholder="00,0">
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted">Altura (m)</label>
                                <input type="number" step="0.01" name="altura" id="inputAltura" class="form-control"
                                       value="{{ paciente.altura_ultima|stringformat:'f' }}" placeholder="1,70">
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted">IMC</label>
                                <input type="text" id="displayIMC" class="form-control bg-white fw-bold" readonly tabindex="-1">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <span id="labelClassificacao" class="badge bg-secondary w-100 p-2">-</span>
                            </div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            Esquema Terapêutico Atual
                            <small class="text-muted fw-normal ms-2">(Selecione as combinações em uso)</small>
                        </h6>

                        <div class="accordion mb-4" id="accordionMeds" style="max-height: 400px; overflow-y: auto;">
                            {% for classe in ordem_classes %}
                                {% with lista_meds=meds_agrupados|get_item:classe %}
                                {% if lista_meds %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                                            <strong>{{ classe }}</strong>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionMeds">
                                        <div class="accordion-body p-2">
                                            {% for med in lista_meds %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="medicamentos" value="{{ med.id }}" id="med{{ med.id }}">
                                                <label class="form-check-label" for="med{{ med.id }}">
                                                    <strong>{{ med.principio_ativo }}</strong>
                                                    <span class="text-muted small">({{ med.dose_padrao }})</span>
                                                    <br><small class="text-muted fst-italic">{{ med.nomes_comerciais }}</small>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Conduta / Observações</label>
                            <textarea name="obs" class="form-control" rows="2" placeholder="Ex: Paciente assintomático, ajustada dose..."></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Salvar Atendimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-5">

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white fw-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>Evolução Clínica
                </div>
                <div class="card-body p-2">
                    <canvas id="chartEvolucao" height="200"></canvas>
                </div>
            </div>

            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Histórico Recente</h6>
                </div>
                <div class="card-body p-0 table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0 text-center" style="font-size: 0.85rem;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Data</th>
                                <th>PA</th>
                                <th>Medicação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reg in historico %}
                            <tr>
                                <td>{{ reg.data_afericao|date:"d/m/y" }}<br><small>{{ reg.data_afericao|date:"H:i" }}</small></td>
                                <td>
                                    {% if reg.pressao_sistolica >= 140 or reg.pressao_diastolica >= 90 %}
                                        <span class="badge bg-danger">{{ reg.pressao_sistolica }}x{{ reg.pressao_diastolica }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ reg.pressao_sistolica }}x{{ reg.pressao_diastolica }}</span>
                                    {% endif %}
                                    {% if reg.imc %}
                                        <br><span class="text-muted" style="font-size: 0.75rem;">IMC: {{ reg.imc }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-start">
                                    {% for m in reg.medicamentos.all %}
                                        <div class="badge bg-light text-dark border mb-1 text-wrap text-start" style="width: 100%;">
                                            {{ m.principio_ativo }}
                                        </div>
                                    {% empty %}
                                        <span class="text-muted">-</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="p-4 text-muted">Sem registros anteriores.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- 1. Lógica do IMC (Formulário) ---
        const inputPeso = document.getElementById('inputPeso');
        const inputAltura = document.getElementById('inputAltura');
        const displayIMC = document.getElementById('displayIMC');
        const labelClassificacao = document.getElementById('labelClassificacao');

        function calcularIMC() {
            let pesoVal = inputPeso.value.replace(',', '.');
            let altVal = inputAltura.value.replace(',', '.');
            const peso = parseFloat(pesoVal);
            const altura = parseFloat(altVal);

            if (peso > 0 && altura > 0) {
                const imc = (peso / (altura * altura)).toFixed(2);
                displayIMC.value = imc;
                let texto = ""; let classe = "";
                if (imc < 18.5) { texto = "Baixo Peso"; classe = "bg-warning text-dark"; }
                else if (imc < 25) { texto = "Eutrófico"; classe = "bg-success"; }
                else if (imc < 30) { texto = "Sobrepeso"; classe = "bg-warning text-dark"; }
                else if (imc < 35) { texto = "Obesidade I"; classe = "bg-danger"; }
                else if (imc < 40) { texto = "Obesidade II"; classe = "bg-danger"; }
                else { texto = "Obesidade III"; classe = "bg-dark"; }
                labelClassificacao.className = `badge w-100 p-2 ${classe}`;
                labelClassificacao.innerText = texto;
            }
        }
        if (inputAltura && inputAltura.value) {
            inputAltura.value = inputAltura.value.replace(',', '.');
            calcularIMC();
        }
        if (inputPeso) inputPeso.addEventListener('input', calcularIMC);
        if (inputAltura) inputAltura.addEventListener('input', calcularIMC);

        // --- 2. Lógica do Gráfico Evolutivo (Chart.js) ---
        {% if paciente and grafico_data.labels %}
            const ctx = document.getElementById('chartEvolucao').getContext('2d');

            // Dados vindos do Django
            const labels = {{ grafico_data.labels|safe }};
            const sysData = {{ grafico_data.sys|safe }};
            const diaData = {{ grafico_data.dia|safe }};
            const pamData = {{ grafico_data.pam|safe }};
            const imcData = {{ grafico_data.imc|safe }};

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PAS (Máx)',
                            data: sysData,
                            borderColor: '#004587', // Azul Seconci
                            backgroundColor: '#004587',
                            yAxisID: 'y_pressao',
                            tension: 0.3
                        },
                        {
                            label: 'PAD (Mín)',
                            data: diaData,
                            borderColor: '#5dade2', // Azul Claro
                            backgroundColor: '#5dade2',
                            yAxisID: 'y_pressao',
                            tension: 0.3
                        },
                        {
                            label: 'PAM (Média)',
                            data: pamData,
                            borderColor: '#198754', // Verde
                            borderDash: [5, 5],
                            pointRadius: 0, // Linha de referência
                            borderWidth: 1,
                            yAxisID: 'y_pressao',
                            tension: 0.3
                        },
                        {
                            label: 'IMC',
                            data: imcData,
                            borderColor: '#F26522', // Laranja Seconci
                            backgroundColor: '#F26522',
                            yAxisID: 'y_imc',
                            type: 'line', // ou 'bar' se preferir
                            borderWidth: 2,
                            pointStyle: 'rectRot',
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y_pressao: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Pressão (mmHg)' },
                            suggestedMin: 40,
                            suggestedMax: 180
                        },
                        y_imc: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'IMC (kg/m²)' },
                            grid: {
                                drawOnChartArea: false, // remove grade do eixo direito para limpar o visual
                            },
                            suggestedMin: 15,
                            suggestedMax: 45
                        }
                    }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}